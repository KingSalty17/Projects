<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA Scheduler Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    
</head>
<body>
    <div class="dashboard">
        <div class="template-sidebar">
            <h2><i class="fas fa-file-alt"></i> Templates</h2>
            <div class="template-search-container">
                <input type="text" id="templateSearch" placeholder="ðŸ” Search templates...">
            </div>
            <div id="templateList"></div>
        </div>

        <div class="form-container">
            <div class="poc-search-container">
                <input type="text" id="pocSearch" placeholder="ðŸ” Search POC by name or position...">
                <div id="pocResults"></div>
            </div>
            
            <div class="selected-poc-card" id="selectedPOC" style="display: none;">
                <div id="pocDetails"></div>
            </div>

            <div id="dynamicForm"></div>
            
            <button class="generate-btn" onclick="generateRA()">
                <i class="fas fa-magic"></i> Generate RA
            </button>

            <div class="output-preview-container">                
                <button class="clear-btn" onclick="clearOutput()">Clear</button>
                <button class="copy-btn" onclick="copyOutput()">Copy</button>
                <div class="output-preview" id="outputPreview"></div>
            </div>
                

        </div>
    </div>

    <script src="pocList.js"></script>
    <script src="templates.js"></script>
    <script src="tempConfigs.js"></script>
    <script>
        let selectedTemplate = null;
        let selectedPOC = null;

        // Initialize application
        function initApp() {
            populateTemplates();
            setupPOCSearch();
            setupTemplateSearch();
        }

        function populateTemplates() {
    const templateList = document.getElementById('templateList');

    // Group templates into categories
    const categorizedTemplates = {
        "HABC Templates": {
            haCleanout: "HABC Cleanout",
            haEviction: "HABC Eviction",
            haRelocation: "HABC Relocation",            
            haBoxDelivery: "HABC Box Delivery",
            haTruckUnload: "HABC Truck Unload"
        },
        "Housing Commission Template": {
            hocRelocation: "HOC Relocation"
        },
        "School Templates": {
            schoolMoving: "School Moving",
            schoolPickupDelivery: "School Pickup & Delivery"
        },
        "Private Sector Templates": {
            privateRelocation: "Private Relocation",
            chamberRelocation: "Chamber Relocation"
        },
        "State's Attorney Templates": {
            saRelocation: "SA Relocation",
            saFurnitureRemoval: "SA Furniture Removal"
        },
        "University Template": {
            universityRelocation: "University Relocation"
        },
        
        "Aging Services Template": {
            agingRelocation: "Aging Relocation"
        },
        
        "Non-Profit Templates": {
            grassrootsRelocation: "Grassroots Relocation"
        },
               
        "Project Management Template": {
            jacobsRelocation: "Jacobs Relocation"
        }
    };

    // Create collapsible sections for each category
    Object.keys(categorizedTemplates).forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'template-category';

        const categoryHeader = document.createElement('h3');
        categoryHeader.textContent = category;
        categoryHeader.className = 'category-header';
        categoryHeader.addEventListener('click', () => {
            const templatesDiv = categoryDiv.querySelector('.templates');
            templatesDiv.style.display = templatesDiv.style.display === 'none' ? 'block' : 'none';
        });

        const templatesDiv = document.createElement('div');
        templatesDiv.className = 'templates';
        templatesDiv.style.display = 'none';

        // Add templates to the category
        const templates = categorizedTemplates[category];
        Object.keys(templates).forEach(key => {
            const card = document.createElement('div');
            card.className = 'template-card';
            card.textContent = templates[key];
            card.addEventListener('click', () => selectTemplate(key));
            templatesDiv.appendChild(card);
        });

        categoryDiv.appendChild(categoryHeader);
        categoryDiv.appendChild(templatesDiv);
        templateList.appendChild(categoryDiv);
    });
}

function setupTemplateSearch() {
    const searchInput = document.getElementById('templateSearch');
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const categories = document.querySelectorAll('.template-category');

        categories.forEach(category => {
            const templates = category.querySelectorAll('.template-card');
            let hasVisibleTemplates = false;

            templates.forEach(template => {
                const templateText = template.textContent.toLowerCase();
                if (templateText.includes(searchTerm)) {
                    template.style.display = 'block';
                    hasVisibleTemplates = true;
                } else {
                    template.style.display = 'none';
                }
            });

            // Show or hide the category based on whether it has visible templates
            category.style.display = hasVisibleTemplates ? 'block' : 'none';
        });
    });
}

        function setupPOCSearch() {
            const searchInput = document.getElementById('pocSearch');
            searchInput.addEventListener('input', debounce(handlePOCSearch, 300));
        }

        function handlePOCSearch(e) {
            const term = e.target.value.toLowerCase();
            const results = pocList.filter(poc => 
                `${poc.firstName} ${poc.lastName}`.toLowerCase().includes(term) ||
                poc.position.toLowerCase().includes(term)
            );

            const resultsContainer = document.getElementById('pocResults');
            resultsContainer.innerHTML = '';
            
            results.forEach(poc => {
                const div = document.createElement('div');
                div.className = 'poc-result';
                div.innerHTML = `
                    <strong>${poc.firstName} ${poc.lastName}</strong>
                    <div>${poc.position} @ ${poc.organization}</div>
                `;
                div.addEventListener('click', () => selectPOC(poc));
                resultsContainer.appendChild(div);
            });

            resultsContainer.style.display = results.length ? 'block' : 'none';
        }

        function selectPOC(poc) {
    selectedPOC = poc;
    document.getElementById('pocResults').style.display = 'none';
    document.getElementById('selectedPOC').style.display = 'block';

    const detailsDiv = document.getElementById('pocDetails');
    detailsDiv.innerHTML = '';

    // Dynamically add only available fields
    const fields = [
        { label: 'POC', value: `${poc.firstName} ${poc.lastName} | ${poc.position} | ${poc.organization} | ${poc.address} | ${poc.phone} |  ${poc.email} ` }

    ];

    fields.forEach(field => {
        if (field.value && field.value !== 'N/A') {
            const fieldElement = document.createElement('p');
            fieldElement.innerHTML = `<strong>${field.label}:</strong> ${field.value}`;
            detailsDiv.appendChild(fieldElement);
        }
    });
}

        function selectTemplate(templateKey) {
            selectedTemplate = templateKey;
            document.querySelectorAll('.template-card').forEach(card => 
                card.classList.remove('active'));
            event.target.classList.add('active');
            createFormFields(templateKey);
        }

        function createFormFields(templateKey) {
    const dynamicForm = document.getElementById('dynamicForm');
    dynamicForm.innerHTML = '';

    // Remove the hardcoded templateConfigs object and use the external one
    if (templateConfigs[templateKey]) {
        dynamicForm.innerHTML = templateConfigs[templateKey];
    } else {
        // Keep the existing fallback logic
        const placeholders = getPlaceholders(templates[templateKey]);
        placeholders.forEach(placeholder => {
            if (['firstName', 'lastName', 'phone', 'email', 'organization', 'position'].includes(placeholder)) return;
            
            const group = document.createElement('div');
            group.className = 'input-group';
            const defaultValue = placeholder.toLowerCase() === 'time' ? '9:00 am' : '';
            group.innerHTML = `
                <label>${formatLabel(placeholder)}</label>
                <input type="text" 
                    id="${placeholder}" 
                    placeholder="Enter ${formatLabel(placeholder)}"
                    value="${defaultValue}">
            `;
            dynamicForm.appendChild(group);
        });
    }
}


function updateCopyButtonVisibility() {
    const outputPreview = document.getElementById('outputPreview');
    const copyButton = document.querySelector('.copy-btn');

    // Show the button only if there is text in the outputPreview
    if (outputPreview.innerHTML.trim()) {
        copyButton.style.display = 'inline-block';
    } else {
        copyButton.style.display = 'none';
    }
}

function copyOutput() {
    const outputPreview = document.getElementById('outputPreview');
    const tempElement = document.createElement('div');
    tempElement.innerHTML = outputPreview.innerHTML;

    // Extract plain text, including bold text
    const textToCopy = tempElement.innerText;

    if (textToCopy) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            alert('Output copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    } else {
        alert('No content to copy!');
    }
}

function clearOutput() {
    const outputPreview = document.getElementById('outputPreview');
    const copyButton = document.querySelector('.copy-btn');
    const clearButton = document.querySelector('.clear-btn');

    // Clear the content of outputPreview
    outputPreview.innerHTML = '';

    // Hide the buttons
    copyButton.style.display = 'none';
    clearButton.style.display = 'none';
}

function updateCopyButtonVisibility() {
    const outputPreview = document.getElementById('outputPreview');
    const copyButton = document.querySelector('.copy-btn');
    const clearButton = document.querySelector('.clear-btn');

    // Show the buttons only if there is text in the outputPreview
    if (outputPreview.innerHTML.trim()) {
        copyButton.style.display = 'inline-block';
        clearButton.style.display = 'inline-block';
    } else {
        copyButton.style.display = 'none';
        clearButton.style.display = 'none';
    }
}


function generateRA() {
    if (!selectedTemplate || !selectedPOC) {
        alert('Please select a template and POC first!');
        return;
    }

    let content = templates[selectedTemplate];
    const placeholders = getPlaceholders(content);

    placeholders.forEach(placeholder => {
        let value = '';

        // Check if the placeholder should come from the form input
        const input = document.getElementById(placeholder);
        if (input) {
            value = input.value; // Prioritize form input values
        } else if (selectedPOC[placeholder]) {
            // Use POC values only if no form input exists for the placeholder
            value = selectedPOC[placeholder];
        }

        // Special handling for time field
        if (placeholder === 'time' && !value) {
            value = '9:00 am';
        }

        // Clean replacement with fallback
        if (value) {
            content = content.replaceAll(`[${placeholder}]`, value);
        } else {
            content = content.replaceAll(`[${placeholder}]`, '');
        }
    });

    // Additional cleanup
    content = content.replace(/\s*\|\s*\|\s*/g, ' | ')
                     .replace(/\s*\|\s*$/g, '')
                     .replace(/^\s*\|\s*/g, '')
                     .replace(/\s*\|\s*(?=\|)/g, '');

    document.getElementById('outputPreview').innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    // Show the copy and clear buttons
    updateCopyButtonVisibility();
}



        // Helper functions remain the same
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getPlaceholders(template) {
            return [...new Set(template.match(/\[(.*?)\]/g).map(p => p.slice(1, -1)))];
        }

        function formatLabel(text) {
            return text.replace(/([A-Z])/g, ' $1').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatTemplateName(key) {
            return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
